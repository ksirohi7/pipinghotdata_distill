---
title: "Your first R package in 1 hour"
description: |
  Tools that make R package development easy
base_url: https://www.pipinghotdata.com/
preview: workshop_thumnnail3.jpg
twitter:
  site: "@PipingHotData"
  creator: "@PipingHotData"
date: 11-05-2020
author:
  - name: Shannon Pileggi
output:
  distill::distill_article:
    toc: true
    toc_depth: 3
    self_contained: false
draft: true
creative_commons: CC BY
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# TL; DR

This blog post accompanies the [R-Ladies Philly](https://www.rladiesphilly.org/){target="_blank"} workshop on November 12, 2020.  
Central idea: leverage [devtools](https://github.com/r-lib/devtools){target="_blank"} and [usethis](https://usethis.r-lib.org/){target="_blank"} in package development!

<aside>
Will update with link to YouTube workshop recording when available.
</aside>

# Abstract

This workshop is for people looking to learn how to make their own R packages and learn how to use “usethis” and “devtools” for package development. The workshop will cover handy one time functions (i.e., `use_this::create_package`) as well as functions used continuously throughout package development (i.e., `devtools::document`). At the end of the hour you should have a working, well-documented package with a single function, as well as a better understanding of the files and file structure required for R packages.

This workshop is suitable for beginner to intermediate R users. Attendees should be familiar with functions, but will not be writing their own function in this workshop. Familiarity with pipe or tidyverse is helpful.

# Disclaimer

![](rollercoaster_package.PNG)

<aside>
Artwork adapted from [`@allison_horst`](https://twitter.com/allison_horst?lang=en){target="_blank"}.
</aside>

I have learned enough about package development to share with you what has worked
well for me; however, I am still learning!  Please reach out if you
have any comments or suggestions.

# Getting started

This material was developed using:

| Software / package  | Version               |
|---------------------|-----------------------|
| R                   | 4.0.2                 | 
| RStudio             | 1.3.1073              | 
| `devtools`          | 2.3.2                 | 
| `usethis`           | 1.6.3                 |
| `tidyverse`         | 1.3.0                 |
| `broom`             | 0.7.1

Please update all software / packages prior to following along with this tutorial, as otherwise errors may arise.

# Toolkit

Single usage functions only need to be used one time in the development process;
multiple usage functions are executed as needed. This table only contains functions
used in this workshop; please note there are many other handy functions in [devtools](https://github.com/r-lib/devtools){target="_blank"} and [usethis](https://usethis.r-lib.org/){target="_blank"} for package development.

| Usage    | Function                                       | Purpose                           |
|----------|------------------------------------------------|-----------------------------------|
| Single   | `usethis::create_package("path/package")`      | initialize package                | 
|          | `usethis::use_mit_license("Your name")`        | adds license                      |
|          | `usethis::use_pipe()`                          | add pipe function as a dependency |
| Multiple | `devtools::check()`                            | build locally and check package   |
|          | `devtools::build()`                            | builds package                    |
|          | `devtools::load_all()`                         | loads functions in `r emo::ji("folder")` `R/` into memory    |
|          | `usethis::use_r("function")`                   | create R script for function      |
|          | `usethis::use_package("package")     `         | add package dependency            |
|          | `devtools::document()`                         | document a function               |

Other resources:

* [Package development](https://rawgit.com/rstudio/cheatsheets/master/package-development.pdf){target="_blank"} cheat sheet

* [R packages](https://r-pkgs.org/){target="_blank"} book by Hadley Wickham and Jenny Bryan

* [How to develop good R packages](https://masalmon.eu/2017/12/11/goodrpackages/){target="_blank"} by Maëlle Salmon

* [R Package Primer](https://kbroman.org/pkg_primer/){target="_blank"} by Karl Broman.

# First package

Open an R session and submit the following, modified to your desired location.  Here,
I am creating a package named `ralph` on my desktop. (This name is inspired by **R**-**L**adies **Ph**illy.) 

```{r create-package, eval=FALSE}
usethis::create_package("C:/Users/Shannon.Pileggi/Desktop/ralph")
```

_insert gif_

Now you have a package!  The `usethis::create_package` function:

1. Creates a new R project named `ralph` at your specified location.

2. Opens the `ralph` project in a new RStudio session.

3. Creates the minimal essential files and structure required for R packages. 

<aside>
See the [package development](https://rawgit.com/rstudio/cheatsheets/master/package-development.pdf){target="_blank"} cheat sheet for picture overview of the full file structure. 
</aside>

# First check

Now that we have a package, let's check it.  Submitting [`devtools::check()`](https://r-pkgs.org/r-cmd-check.html){target="_blank"} updates package documentation, builds the package, and submits over 50 checks for metadata, structure, R code, documentation, and more! 

```{r check-package-1, eval=FALSE}
devtools::check()
```

This can take a while to run, depending on how big your package is.  It
is helpful to run frequently, especially if you are planning
on submitting to CRAN.  But even for internal packages, it is still
good practice.  

_insert gif or screenshot_

Our first check results in a single warning - that our package needs a license.  You can see this in the description file:

_insert screenshot_

To fix this, add the [license](https://r-pkgs.org/description.html#description-license){target="_blank"} of your choice.  A standard recommendation is the MIT license due to broad permissions.  

```{r use-license, eval=FALSE}
usethis::use_mit_license("Your name")
```

This updates the description file, as well as creates two new license files in your project that you never have to touch.

_insert screenshot_

You can go back and complete the remaining [description](https://r-pkgs.org/description.html){target="_blank"} fields later.  For now, re-submit 

```{r check-package-2, eval=FALSE}
devtools::check()
```

and now our package is error, warning, and note free.

_insert screenshot_

# First function

### Create

The `compute_corr` function is a wrapper for `cor.test` to produce tidy output for Pearson's correlation estimate (along with a p-value) to quantify the linear relationship between two quantitative variables.

```{r define-function, eval = TRUE}
compute_corr <- function(data, var1, var2){
  
  cor.test(x = data[[var1]], y = data[[var2]]) %>% 
    # tidy up results ----
    broom::tidy() %>% 
    # retain and rename relevant bits ----
    dplyr::select(
      correlation = estimate, 
      pval = p.value
    )
  
}
```

Let's add the `compute_corr` function to `ralph`.

```{r create-function, eval=FALSE}
usethis::use_r("compute_corr")
```

This creates a blank R script named `compute_corr.R` located in `R/` folder.  It is convention that your function name and R script name are the same.  Copy and paste the function to the blank R script, and then save.

_insert screenshot_

### Execute

Take your function for a [test drive](https://r-pkgs.org/workflows101.html#load-all){target="_blank"} with `devtool::load_all` ("arguably the most important part of the devtools workflow").

```{r, eval = FALSE}
devtools::load_all()
```

This places your function in local memory so that you may tinker and confirm its 
execution.  Let's give it a try.

```{r include=FALSE}
library(tidyverse)
```


```{r}
compute_corr(mpg, "cty", "hwy")
```

### Document

Next [document](https://r-pkgs.org/man.html){target="_blank"} the `compute_corr` function using the Roxygen skeleton. You can add this two ways:

1. `Code -> Insert Roxygen Skeleton`, or 

2. `Cntrl + Alt + Shift + R`

Now you should see this:

_insert image_

where we now have an outline to fill in.  Note that the three arguments
in our function (`data`, `var1`, `var2`) were automatically detected.  Update the documentation as follows:


```{r, eval = FALSE}
#' Computes a tidy correlation
#'
#' @param data input data set
#' @param var1 a quoted character string for the name of variable 1
#' @param var2 a quoted character string for the name of variable 2
#'
#' @return A tibble with the Pearson correlation and the p-value
#' @export
#'
#' @examples
#' compute_corr(data = mtcars, var1 = "hp", var2 = "mpg")
```


_insert screenshot_

Now submit

```{r document-function, eval = FALSE}
devtools::document()
```

This did a lot of work for you!

_insert screenshot_

1. The `man` folder (short for `manual`) has been created in your package.

2. The `man` folder now contains a file called `compute_corr.Rd`.  This is the documentation for your function; you never edit this manually.

3. Your `NAMESPACE` also now says that we have a function in your package to export. 

We can preview the documentation with:

```{r preview-documentation, eval = FALSE}
?compute_corr
```

_insert screenshot_

If you want to modify your documentation, make the changes in the Roxygen skeleton in `compute_corr.R` and then resubmit `devtools::document()`.


### Check

Now submit 

```{r check-package-3, eval=FALSE}
devtools::check()
```

and you'll see that we have some concerns.

_insert screenshot_

This is because our `compute_corr` depends on functions from other packages, such as:

1. The pipe function ` %>%` from the `magrittr` package.

2. The `tidy` function from the `broom` package.

3. The `select` function from the `dplyr` package.

### Dependencies

We can fix these errors by specifying the dependencies in the `compute_corr` function.  

**1. Package dependencies**

To specify a [package dependency](https://r-pkgs.org/description.html#dependencies){target="_blank"}, the name of the package needs to be listed in the `DESCRIPTION` file.  This can be automatically done for you by submitting

```{r, eval = F}
usethis::use_package("broom")
usethis::use_package("dplyr")
```
 

_insert screenshot_

**2. Functions within packages**

There are three ways you can specify required [functions within packages](https://r-pkgs.org/namespace.html#import-r){target="_blank"}.  

1. Use the `::` notation within your function, as in `broom::tidy` (recommended, used in this post).

2. In the Roxygen section of your function, use `@importFrom pkg fun1 fun2` - if you prefer this over using `::`.

3. In the Roxygen section of your function, `@import pkg` - imports all functions from a package; use sparingly/wisely as makes your package bulkier.

**Special case** 

The pipe (`%>%`) function from the `magrittr` package is a special case. The easiest way to include the pipe is

```{r, eval = F}
usethis::use_pipe()  # step 1 ----
devtools::document() # step 2 ----
```

Here, step 1 creates `utils-pipe.R` in your `R` folder, and step 2 adds the pipe to your `NAMESPACE` file.

_insert screenshot_

Now let's run the check again:

```{r, eval = F}
devtools::check()
```

Can you diagnose the note this time? What steps would you take to correct it?  I'm saving this for discussion in the 
workshop.^[We missed specifying an additional package dependency in the `compute_corr` function - that the `cor.test` function is from the `stats` package. 
Update the `compute_corr` function with `stats::cor.test`, and then `devtools::check()` again.] 


_insert screenshot_

# Installing your package

Open a new R session.  Install your package from your local directory, load your
package, and execute your functions. 

```{r, eval = F}
# install package ----
devtools::install("C:/Users/Shannon.Pileggi/Desktop/ralph")
```


```{r, eval = F}
# load package ----
library(ralph)
```


```{r, eval = TRUE}
# execute function ----
compute_corr(data = mtcars, var1 = "hp", var2 = "mpg")
```


# Summary 

I hope you feel empowered to start developing your own packages now! We went 
through many of these steps one time only; however, in the development process,
many of these step are iterative. Here is a re-cap of our steps, although
your work flow may differ. 

| Action                                  | How                                          |
|-----------------------------------------|----------------------------------------------|
|  1. Load development packages.          | `library(usethis)`, `library(devtools)`      | 
|  2. Create new package.                 | `usethis::create_package("path/package")`    |
|  3. Check build.                        | `devtools::check()`                          | 
|  4. Add a license.                      | `usethis::use_mit_license("Your name")`      |
|  5. Check build.                        | `devtools::check()`                          |
|  6. Create a new function.              | `usethis::use_r("function")`                 |
|  7. Test drive function.                | `devtools::load_all()`                       |
|  8. Insert Roxygen skeleton.            | `Menu -> Code -> Insert Roxygen Skeleton`    |
|  9. Document package.                   | `devtools::document()`                       |
| 10. Check build.                        | `devtools::check()`                          |
| 11. Specify package dependencies.       | `usethis::use_package("package")`            |
| 12. Specify functions within packages.  | `package::function`                          |
| 13. Document package.                   | `devtools::document()`                       |
| 14. Check build.                        | `devtools::check()`                          |


# Acknowledgements

Thank you [R-Ladies Philly](https://www.rladiesphilly.org/){target="_blank"} for hosting this workshop!  [Chun Su](https://learniningwithsckinta.netlify.app/){target="_blank"} kindly created the thumbnail image for this workshop.  <insert name(s)> provided feedback on this post and the workshop content. I learned much of this content from 
attending the rstudio::conf2020 [Building Tidy Tools](https://github.com/rstudio-conf-2020/build-tidy-tools){target="_blank"} workshop co-instructed by Charlotte Wickham and Hadley Wickham.  Shout out to Hillary Parker for showing us [how to build packages from scratch in 2014](https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/){target="_blank"}.